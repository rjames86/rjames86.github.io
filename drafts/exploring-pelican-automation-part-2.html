<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="#ff6b00" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#ff6b00" media="(prefers-color-scheme: dark)">

<link rel="me" href="https://mastodon.social/@rjames">
<meta name="fediverse:creator" content="@rjames@mastodon.social">

<meta name="author" content="Ryan M">
<meta name="description" content="Posts and writings by Ryan M">
    <link rel="alternate" title="ryanmo.co JSON Feed" type="application/json" href="feed.json" />
    <link href="http://feedpress.me/ryanmoco" type="application/rss+xml" rel="alternate" title="ryanmo.co Full RSS Feed" />

    <title>Exploring Pelican: Part 2 - ryanmo.co</title>
    <link rel="stylesheet" href="https://ryanmo.co/theme/css/style.css">
</head>
<body>
    <!-- Fixed navigation banner -->
    <div class="nav-banner">
        <div class="nav-container">
            <h2 class="site-title"><a href="https://ryanmo.co/">ryanmo.co</a></h2>
            <nav class="nav-links">
                <a href="https://ryanmo.co/">Home</a>
                <a href="https://ryanmo.co/about">About</a>
            </nav>
        </div>
    </div>

    <header>
    </header>

    <main>
<article>
    <h1>Exploring Pelican: Part 2</h1>
    <div class="article-meta">
        <time datetime="2017-12-03T15:22:00-08:00">2017-12-03</time>
        by Ryan M
        in <a href="https://ryanmo.co/category/tech">Tech</a>
    </div>
    <p>If I spent half as much time posting blog posts as I did actually messing around with Pelican, I'd have a lot more posts by now. I've been using Pelican now for almost 4 years and have constantly been tweaking it. I've created a lot of fun things that make the overall use of Pelican much nicer and make it easier to create posts and maintain a clean folder structure.</p>
<!-- PELICAN_END_SUMMARY -->

<p>Back in 2013, I <a href="{static}../2013-12-29/Exploring-Pelican-Automation.md">wrote about</a> the automation I was doing with Pelican. I don't think I'm using any of that now, but have found some new ways to not necessarily automate, but just make Pelican nicer to use. Here are a few of the things I've been up to.</p>
<h2 id="code-snippets">Code Snippets</h2>
<p>I post a lot of code snippets in my posts. Writing (or even pasting) in code into Markdown isn't my favorite. If I have to edit the snippet, I almost always re-open the post in Sublime Text, edit, and then go back to my editor. Embedding gists is convenient, but I don't like the way that embeds are done and it's just one more place for me to have to go. What I ended up doing was creating a Jinja extension where I could define my own syntax for adding in any text from a separate file. Now, instead of writing any code in my posts, I can use the syntax <code>{ ! my_snippet.py ! }</code>  for inserting a code snippet. This also cleans up the posts a lot.</p>
<h2 id="custom-markdown-reader">Custom Markdown Reader</h2>
<p>The first step was to write a Jinja preprocessor extension that would parse my new syntax. </p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Idea based on https://github.com/cmacmackin/markdown-include/blob/master/markdown_include/include.py</span>

<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">from</span> <span class="nn">codecs</span> <span class="kn">import</span> <span class="nb">open</span>
<span class="kn">from</span> <span class="nn">markdown.extensions</span> <span class="kn">import</span> <span class="n">Extension</span>
<span class="kn">from</span> <span class="nn">markdown.preprocessors</span> <span class="kn">import</span> <span class="n">Preprocessor</span>

<span class="kn">import</span> <span class="nn">logging</span>

<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># {! some_code_path.txt !}</span>
<span class="n">INC_SYNTAX</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\{!\s*(.+?)\s*!\}&#39;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">MarkdownInclude</span><span class="p">(</span><span class="n">Extension</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">configs</span><span class="o">=</span><span class="p">{}):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;base_path&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;Default location from which to evaluate &#39;</span>
                          <span class="s1">&#39;from the default path.&#39;</span><span class="p">],</span>
            <span class="s1">&#39;source_path&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;Default location from which to evaluate &#39;</span>
                            <span class="s1">&#39;relative paths from the file.&#39;</span><span class="p">],</span>
            <span class="s1">&#39;encoding&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="s1">&#39;Encoding of the files used by the include &#39;</span>
                         <span class="s1">&#39;statement.&#39;</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">configs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setConfig</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">extendMarkdown</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">md</span><span class="p">):</span>
        <span class="n">md</span><span class="o">.</span><span class="n">preprocessors</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">IncludePreprocessor</span><span class="p">(</span><span class="n">md</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">getConfigs</span><span class="p">()),</span> <span class="s1">&#39;include&#39;</span><span class="p">,</span> <span class="mi">101</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">IncludePreprocessor</span><span class="p">(</span><span class="n">Preprocessor</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">md</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">IncludePreprocessor</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">md</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_path</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;base_path&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source_path</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;source_path&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;encoding&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">loc</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">INC_SYNTAX</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">):</span>
                    <span class="n">dir_to_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_path</span>
                    <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dir_to_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_path</span>

                <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
                    <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_to_file</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span> <span class="k">as</span> <span class="n">r</span><span class="p">:</span>
                        <span class="n">text</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Could not find file {}. Error: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                    <span class="c1"># lines[loc] = INC_SYNTAX.sub(&#39;&#39;, line) # to remove</span>
                    <span class="k">continue</span>

                <span class="c1"># indent text</span>
                <span class="n">text</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">text</span><span class="p">]</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[:</span><span class="n">loc</span><span class="p">]</span> <span class="o">+</span> <span class="n">text</span> <span class="o">+</span> <span class="n">lines</span><span class="p">[</span><span class="n">loc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
        <span class="k">return</span> <span class="n">lines</span>


<span class="k">def</span> <span class="nf">makeExtension</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">MarkdownInclude</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div>

<p>This was a lot less work than it appears. This same structure exists already for Pelican's <code>{static}</code> and <code>{attach}</code>.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">pelican</span> <span class="kn">import</span> <span class="n">signals</span>
<span class="kn">from</span> <span class="nn">pelican.readers</span> <span class="kn">import</span> <span class="n">Markdown</span><span class="p">,</span> <span class="n">MarkdownReader</span>
<span class="kn">from</span> <span class="nn">pelican.utils</span> <span class="kn">import</span> <span class="n">pelican_open</span>

<span class="kn">from</span> <span class="nn">lib.gist</span> <span class="kn">import</span> <span class="n">MarkdownInclude</span>


<span class="k">class</span> <span class="nc">CustomMarkdownReader</span><span class="p">(</span><span class="n">MarkdownReader</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_path</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_source_path</span> <span class="o">=</span> <span class="n">source_path</span>
        <span class="n">default_extensions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;MARKDOWN&#39;</span><span class="p">][</span><span class="s1">&#39;extensions&#39;</span><span class="p">]</span>
        <span class="n">default_extensions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">MarkdownInclude</span><span class="p">(</span><span class="n">configs</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;base_path&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;CONTENT_PATH&#39;</span><span class="p">],</span>
                <span class="s1">&#39;source_path&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">source_path</span><span class="p">)</span>
            <span class="p">})</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_md</span> <span class="o">=</span> <span class="n">Markdown</span><span class="p">(</span><span class="n">extensions</span><span class="o">=</span><span class="n">default_extensions</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">pelican_open</span><span class="p">(</span><span class="n">source_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">text</span><span class="p">:</span>
            <span class="n">content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_md</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_md</span><span class="p">,</span> <span class="s1">&#39;Meta&#39;</span><span class="p">):</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_metadata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_md</span><span class="o">.</span><span class="n">Meta</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">return</span> <span class="n">content</span><span class="p">,</span> <span class="n">metadata</span>


<span class="k">def</span> <span class="nf">add_reader</span><span class="p">(</span><span class="n">readers</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">MarkdownReader</span><span class="o">.</span><span class="n">file_extensions</span><span class="p">:</span>
        <span class="n">readers</span><span class="o">.</span><span class="n">reader_classes</span><span class="p">[</span><span class="n">ext</span><span class="p">]</span> <span class="o">=</span> <span class="n">CustomMarkdownReader</span>


<span class="k">def</span> <span class="nf">register</span><span class="p">():</span>
    <span class="n">signals</span><span class="o">.</span><span class="n">readers_init</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">add_reader</span><span class="p">)</span>
</code></pre></div>

<h2 id="json-feed">JSON Feed</h2>
<h2 id="mixed-content-in-the-same-directory">Mixed Content in the Same Directory</h2>
<div class="codehilite"><pre><span></span><code><span class="err">2017-07-04/ # folder for post is the date</span>
<span class="err">├── exploring_pelican.md # this post</span>
<span class="err">├── code_snippet.txt # this folder structure example as a code snippet</span>
<span class="err">└── some_image.png</span>
</code></pre></div>

<h2 id="drafts-category">Drafts Category</h2>
<div class="codehilite"><pre><span></span><code>
</code></pre></div>

<p>{! /../theme/templates/drafts.html !}</p>
</article>
    </main>

    <footer>
        <p>&copy;  Ryan M. Powered by <a href="https://getpelican.com">Pelican</a></p>
    </footer>
</body>
</html>